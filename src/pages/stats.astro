---
import BaseLayout from "../layouts/BaseLayout.astro";
import gradesData from "../data/grades.json";

const classes = gradesData.classes ?? [];
const gradeHistory = gradesData.grade_history ?? {};
const overallAverage = gradesData.overall_average ?? null;
const streak = gradesData.streak ?? 0;

const parseDate = (value: string): number => {
  const parsed = Date.parse(value);
  return Number.isNaN(parsed) ? 0 : parsed;
};

const allDates = new Set<string>();
Object.values(gradeHistory).forEach((history) => {
  Object.keys(history ?? {}).forEach((date) => allDates.add(date));
});

const sortedDates = Array.from(allDates).sort(
  (a, b) => parseDate(a) - parseDate(b)
);

const averageSeries = sortedDates
  .map((date) => {
    let sum = 0;
    let count = 0;
    Object.values(gradeHistory).forEach((history) => {
      const value = history?.[date];
      if (typeof value === "number") {
        sum += value;
        count += 1;
      }
    });
    if (!count) return null;
    return {
      date,
      value: Math.round((sum / count) * 10) / 10,
    };
  })
  .filter((point): point is { date: string; value: number } => Boolean(point));

const values = averageSeries.map((point) => point.value);
const seriesMin = values.length ? Math.min(...values) : 0;
const seriesMax = values.length ? Math.max(...values) : 100;
const range = seriesMax - seriesMin;
const normalizedMin = range < 1 ? Math.max(0, seriesMin - 10) : seriesMin;
const normalizedMax = range < 1 ? Math.min(100, seriesMax + 10) : seriesMax;
const normalizedRange = normalizedMax - normalizedMin || 1;

const viewBoxWidth = 900;
const viewBoxHeight = 260;
const paddingLeft = 60;
const paddingRight = 30;
const paddingTop = 30;
const paddingBottom = 50;
const plotWidth = viewBoxWidth - paddingLeft - paddingRight;
const plotHeight = viewBoxHeight - paddingTop - paddingBottom;

const chartPoints = averageSeries.map((point, index) => {
  const progress = averageSeries.length > 1
    ? index / (averageSeries.length - 1)
    : 0;
  const x = paddingLeft + progress * plotWidth;
  const y = paddingTop + (1 - (point.value - normalizedMin) / normalizedRange) * plotHeight;
  return { ...point, x, y };
});

const linePath = chartPoints
  .map((point, index) => `${index === 0 ? "M" : "L"}${point.x.toFixed(2)} ${point.y.toFixed(2)}`)
  .join(" ");

const bestClass = classes.reduce((best, next) => {
  if (!best) return next;
  return next.current_grade > best.current_grade ? next : best;
}, classes[0]);

const toughestClass = classes.reduce((worst, next) => {
  if (!worst) return next;
  return next.current_grade < worst.current_grade ? next : worst;
}, classes[0]);

const recentDelta = averageSeries.length > 1
  ? averageSeries[averageSeries.length - 1].value - averageSeries[averageSeries.length - 2].value
  : 0;

const trendLabel = recentDelta > 0 ? "RISING" : recentDelta < 0 ? "DROPPING" : "STEADY";
const trendValue = Math.round(recentDelta * 10) / 10;

const firstDate = averageSeries.length ? averageSeries[0].date : "";
const lastDate = averageSeries.length ? averageSeries[averageSeries.length - 1].date : "";
---

<BaseLayout>
  <div class="max-w-[1400px] mx-auto">
    <div class="mb-6">
      <a
        href="/"
        class="inline-flex items-center gap-2 text-[#00ff00] hover:text-[#00cc00] transition-colors text-[0.6em] uppercase border-2 border-[#00ff00] hover:border-[#00cc00] px-4 py-2 bg-[#000]"
      >
        <span>BACK TO GRADES</span>
      </a>
    </div>

    <div class="shadow-[0_0_0_4px_#000,0_0_0_8px_#fff,8px_8px_0_8px_rgba(255,255,255,0.3)] relative p-6 border-4 border-solid border-white card mb-8">
      <div class="flex items-center gap-[15px] mb-5 pb-[15px] border-b-[3px] border-b-[#555] border-dashed">
        <div class="w-12 h-12 flex items-center justify-center text-[1.2em] border-[3px] border-solid border-[#00ff00] bg-[#000]">
          ST
        </div>
        <div>
          <h1 class="text-[0.8em] text-[#00ff00] uppercase mb-2">STATS.ROOM</h1>
          <p class="text-[0.6em] text-[#aaa]">DAILY SIGNALS AND GRADE POWER UPS</p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-[#000] p-4 border-[3px] border-solid border-[#555]">
          <div class="text-[0.5em] text-[#aaa] uppercase mb-2">Overall Average</div>
          <div class="text-[1.1em] text-[#00ff00]">{overallAverage ?? "--"}%</div>
        </div>
        <div class="bg-[#000] p-4 border-[3px] border-solid border-[#555]">
          <div class="text-[0.5em] text-[#aaa] uppercase mb-2">Streak</div>
          <div class="text-[1.1em] text-[#00ffff]">{streak}</div>
        </div>
        <div class="bg-[#000] p-4 border-[3px] border-solid border-[#555]">
          <div class="text-[0.5em] text-[#aaa] uppercase mb-2">Recent Trend</div>
          <div class="text-[1.1em] text-[#ffff00]">{trendLabel} {trendValue >= 0 ? "+" : ""}{trendValue}%</div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-[2fr,1fr] gap-6">
      <div class="shadow-[0_0_0_4px_#000,0_0_0_8px_#fff,8px_8px_0_8px_rgba(255,255,255,0.3)] relative p-6 border-4 border-solid border-white card">
        <div class="flex items-center gap-[15px] mb-5 pb-[15px] border-b-[3px] border-b-[#555] border-dashed">
          <div class="w-12 h-12 flex items-center justify-center text-[1.2em] border-[3px] border-solid border-[#00ff00] bg-[#000]">
            CH
          </div>
          <div class="text-[0.7em] text-[#00ff00]">GRADE SIGNAL</div>
        </div>

        <div class="bg-[#000] border-[3px] border-solid border-[#555] p-4">
          <svg
            viewBox={`0 0 ${viewBoxWidth} ${viewBoxHeight}`}
            class="w-full h-[260px]"
            role="img"
            aria-label="Average grade trend over time"
          >
            <rect x="0" y="0" width="100%" height="100%" fill="#000" />
            <g stroke="#1f2933" stroke-width="2">
              {Array.from({ length: 5 }).map((_, index) => {
                const y = paddingTop + (plotHeight / 4) * index;
                return <line x1={paddingLeft} y1={y} x2={viewBoxWidth - paddingRight} y2={y} />;
              })}
            </g>
            <g stroke="#00ff00" stroke-width="3" fill="none" opacity="0.8">
              <path d={linePath} />
            </g>
            <g fill="#00ffff">
              {chartPoints.map((point) => (
                <circle cx={point.x} cy={point.y} r="5" class="pulse-dot" />
              ))}
            </g>
            <g fill="#00ff00" font-size="20">
              <text x="8" y={paddingTop + 6}>{Math.round(normalizedMax)}%</text>
              <text x="8" y={paddingTop + plotHeight + 6}>{Math.round(normalizedMin)}%</text>
            </g>
            <g fill="#aaa" font-size="20">
              <text x={paddingLeft} y={viewBoxHeight - 15}>{firstDate}</text>
              <text x={viewBoxWidth - paddingRight - 120} y={viewBoxHeight - 15}>{lastDate}</text>
            </g>
          </svg>
        </div>
      </div>

      <div class="shadow-[0_0_0_4px_#000,0_0_0_8px_#fff,8px_8px_0_8px_rgba(255,255,255,0.3)] relative p-6 border-4 border-solid border-white card">
        <div class="flex items-center gap-[15px] mb-5 pb-[15px] border-b-[3px] border-b-[#555] border-dashed">
          <div class="w-12 h-12 flex items-center justify-center text-[1.2em] border-[3px] border-solid border-[#00ff00] bg-[#000]">
            HX
          </div>
          <div class="text-[0.7em] text-[#00ff00]">CLASS HIGHLIGHTS</div>
        </div>

        <div class="space-y-4">
          <div class="bg-[#000] p-4 border-[3px] border-solid border-[#555]">
            <div class="text-[0.5em] text-[#aaa] uppercase mb-2">Best Class</div>
            <div class="text-[0.7em] text-white uppercase">{bestClass?.class_name ?? "--"}</div>
            <div class="text-[0.6em] text-[#00ff00]">{bestClass?.current_grade ?? "--"}%</div>
          </div>
          <div class="bg-[#000] p-4 border-[3px] border-solid border-[#555]">
            <div class="text-[0.5em] text-[#aaa] uppercase mb-2">Toughest Class</div>
            <div class="text-[0.7em] text-white uppercase">{toughestClass?.class_name ?? "--"}</div>
            <div class="text-[0.6em] text-[#E60A18]">{toughestClass?.current_grade ?? "--"}%</div>
          </div>
          <div class="bg-[#000] p-4 border-[3px] border-solid border-[#555]">
            <div class="text-[0.5em] text-[#aaa] uppercase mb-2">Signal Window</div>
            <div class="text-[0.6em] text-[#aaa]">{firstDate && lastDate ? `${firstDate} to ${lastDate}` : "--"}</div>
            <div class="text-[0.6em] text-[#00ffff]">{averageSeries.length} checks logged</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .pulse-dot {
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0% {
        r: 4;
        opacity: 0.6;
      }
      50% {
        r: 7;
        opacity: 1;
      }
      100% {
        r: 4;
        opacity: 0.6;
      }
    }
  </style>
</BaseLayout>

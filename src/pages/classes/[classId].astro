---
import BaseLayout from "../../layouts/BaseLayout.astro";
import GradeCalculator from "../../components/GradeCalculator.astro";
import gradesData from "../../data/grades.json";
import type { Class, Assignment } from "../../types/grades";

export function getStaticPaths() {
  const classes = gradesData.classes as Class[];
  return classes.map((classInfo) => ({
    params: { classId: classInfo.class_id || classInfo.period },
    props: { classInfo },
  }));
}

const { classInfo } = Astro.props as { classInfo: Class };

function getGradeColor(grade: number): string {
  if (grade >= 90) return "grade-a";
  if (grade >= 80) return "grade-b";
  if (grade >= 70) return "grade-c";
  if (grade >= 60) return "grade-d";
  return "grade-f";
}

function getScoreDisplay(assignment: Assignment): string {
  if (assignment.score === null) {
    return "MISSING";
  }
  return `${assignment.score}/${assignment.maxPoints}`;
}

function getPercentageDisplay(assignment: Assignment): string {
  if (assignment.percentage === null) {
    return "0%";
  }
  return `${assignment.percentage}%`;
}

const assignments = classInfo.assignments || [];
const hasAssignments = assignments.length > 0;
---

<BaseLayout>
  <div class="max-w-[1400px] mx-auto">
    <!-- Back Navigation -->
    <div class="mb-6">
      <a
        href="/"
        class="inline-flex items-center gap-2 text-[#00ff00] hover:text-[#00cc00] transition-colors text-[0.6em] uppercase border-2 border-[#00ff00] hover:border-[#00cc00] px-4 py-2 bg-[#000]"
      >
        <span>‚Üê BACK TO GRADES</span>
      </a>
    </div>

    <!-- Class Header Card -->
    <div
      class="shadow-[0_0_0_4px_#000,0_0_0_8px_#fff,8px_8px_0_8px_rgba(255,255,255,0.3)] relative p-5 border-4 border-solid border-white card mb-8"
    >
      <div
        class="flex items-center gap-[15px] mb-5 pb-[15px] border-b-[3px] border-b-[#555] border-dashed"
      >
        <div
          class="w-12 h-12 flex items-center justify-center text-[1.2em] border-[3px] border-solid border-[#00ff00] bg-[#000]"
        >
          üìä
        </div>
        <div class="flex-1">
          <h1 class="text-[0.8em] text-[#00ff00] uppercase mb-2">
            CLASS.DETAILS - PERIOD {classInfo.period}
          </h1>
          <h2 class="text-[1em] text-white">
            {classInfo.class_name}
          </h2>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-[#000] p-4 border-[3px] border-solid border-[#555]">
          <div class="text-[0.5em] text-[#aaa] uppercase mb-2">Teacher</div>
          <div class="text-[0.7em] text-white">{classInfo.teacher}</div>
        </div>

        <div class="bg-[#000] p-4 border-[3px] border-solid border-[#555]">
          <div class="text-[0.5em] text-[#aaa] uppercase mb-2">
            Current Grade
          </div>
          <div class="flex gap-2 items-center">
            <span
              class={`grade-badge ${getGradeColor(classInfo.current_grade)}`}
            >
              {classInfo.letter_grade}
            </span>
            <span
              class={`grade-badge ${getGradeColor(classInfo.current_grade)}`}
            >
              {classInfo.current_grade}%
            </span>
          </div>
        </div>

        {
          classInfo.q1_grade !== null && (
            <div class="bg-[#000] p-4 border-[3px] border-solid border-[#555]">
              <div class="text-[0.5em] text-[#aaa] uppercase mb-2">
                Q1 Grade
              </div>
              <div class="flex gap-2 items-center">
                <span
                  class={`grade-badge ${getGradeColor(classInfo.q1_grade)}`}
                >
                  {classInfo.q1_letter_grade}
                </span>
                <span
                  class={`grade-badge ${getGradeColor(classInfo.q1_grade)}`}
                >
                  {classInfo.q1_grade}%
                </span>
              </div>
            </div>
          )
        }

        {
          classInfo.q2_grade !== null && (
            <div class="bg-[#000] p-4 border-[3px] border-solid border-[#555]">
              <div class="text-[0.5em] text-[#aaa] uppercase mb-2">
                Q2 Grade
              </div>
              <div class="flex gap-2 items-center">
                <span
                  class={`grade-badge ${getGradeColor(classInfo.q2_grade)}`}
                >
                  {classInfo.q2_letter_grade}
                </span>
                <span
                  class={`grade-badge ${getGradeColor(classInfo.q2_grade)}`}
                >
                  {classInfo.q2_grade}%
                </span>
              </div>
            </div>
          )
        }
      </div>
    </div>

    <!-- Grade Calculator -->
    <GradeCalculator classInfo={classInfo} />

    <!-- Assignments Section -->
    <div
      class="shadow-[0_0_0_4px_#000,0_0_0_8px_#fff,8px_8px_0_8px_rgba(255,255,255,0.3)] relative p-5 border-4 border-solid border-white card"
    >
      <div
        class="flex items-center gap-[15px] mb-5 pb-[15px] border-b-[3px] border-b-[#555] border-dashed"
      >
        <div
          class="w-12 h-12 flex items-center justify-center text-[1.2em] border-[3px] border-solid border-[#00ff00] bg-[#000]"
        >
          üìù
        </div>
        <div class="text-[0.7em] text-[#00ff00]">ASSIGNMENTS.LOG</div>
      </div>

      {
        !hasAssignments ? (
          <div class="text-center py-8">
            <div class="text-[0.6em] text-[#aaa] uppercase">
              No assignment data available for this class yet.
            </div>
            <div class="text-[0.5em] text-[#666] mt-2">
              Run the scraper to collect assignment details.
            </div>
          </div>
        ) : (
          <div class="overflow-x-auto">
            <table class="w-full border-collapse">
              <thead>
                <tr class="border-b-[3px] border-b-[#555]">
                  <th class="text-left p-3 text-[0.5em] text-[#00ff00] uppercase">
                    Assignment
                  </th>
                  <th class="text-left p-3 text-[0.5em] text-[#00ff00] uppercase">
                    Category
                  </th>
                  <th class="text-left p-3 text-[0.5em] text-[#00ff00] uppercase">
                    Due Date
                  </th>
                  <th class="text-right p-3 text-[0.5em] text-[#00ff00] uppercase">
                    Score
                  </th>
                  <th class="text-right p-3 text-[0.5em] text-[#00ff00] uppercase">
                    Percentage
                  </th>
                  <th class="text-center p-3 text-[0.5em] text-[#00ff00] uppercase">
                    Status
                  </th>
                </tr>
              </thead>
              <tbody>
                {assignments.map((assignment) => (
                  <tr class="border-b border-b-[#333] hover:bg-[#1a1a1a] transition-colors">
                    <td class="p-3 text-[0.5em] text-white">
                      {assignment.name}
                    </td>
                    <td class="p-3 text-[0.5em] text-[#aaa]">
                      {assignment.category}
                    </td>
                    <td class="p-3 text-[0.5em] text-[#aaa]">
                      {assignment.dueDate}
                    </td>
                    <td
                      class={`p-3 text-right text-[0.5em] ${assignment.status === "missing" ? "text-[#E60A18]" : "text-white"}`}
                    >
                      {getScoreDisplay(assignment)}
                    </td>
                    <td class="p-3 text-right">
                      {assignment.percentage !== null ? (
                        <span
                          class={`grade-badge ${getGradeColor(assignment.percentage)}`}
                        >
                          {getPercentageDisplay(assignment)}
                        </span>
                      ) : (
                        <span class="text-[0.5em] text-[#E60A18]">
                          {getPercentageDisplay(assignment)}
                        </span>
                      )}
                    </td>
                    <td class="p-3 text-center">
                      {assignment.status === "missing" ? (
                        <span class="text-[0.5em] px-3 py-1 bg-[#E60A18] text-white border-2 border-white uppercase">
                          ‚ùå Missing
                        </span>
                      ) : assignment.status === "pending" ? (
                        <span class="text-[0.5em] px-3 py-1 bg-[#E69E18] text-black border-2 border-white uppercase">
                          ‚è≥ Pending
                        </span>
                      ) : (
                        <span class="text-[0.5em] px-3 py-1 bg-[#01BC61] text-black border-2 border-white uppercase">
                          ‚úì Graded
                        </span>
                      )}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )
      }
    </div>
  </div>
</BaseLayout>

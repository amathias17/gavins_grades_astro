---
import BaseLayout from "../../layouts/BaseLayout.astro";
import GradeCalculator from "../../components/GradeCalculator.astro";
import gradesData from "../../data/grades.json";
import type { Class, Assignment } from "../../types/grades";
import fs from "node:fs/promises";
import path from "node:path";

type ScrapedAssignment = {
  name: string;
  dueDate: string | null;
  earnedPoints: number;
  totalPoints: number;
  graded: boolean;
};

type ScrapedClass = {
  className: string;
  period: string;
  assignments: ScrapedAssignment[];
};

type ScrapedGrades = {
  classes?: ScrapedClass[];
};

export async function getStaticPaths() {
  const normalizeClassName = (value: string): string =>
    value.trim().toLowerCase().replace(/[^a-z0-9]+/g, " ");
  const normalizePeriod = (value: string): string => value.trim();

  const classes = gradesData.classes as Class[];
  let scrapedClasses: ScrapedClass[] = [];
  try {
    const scrapedPath = path.resolve("scraper", "detailed-grades.json");
    const raw = await fs.readFile(scrapedPath, "utf8");
    const parsed = JSON.parse(raw) as ScrapedGrades;
    scrapedClasses = parsed?.classes ?? [];
  } catch (error) {
    scrapedClasses = [];
  }
  const scrapedByPeriod = new Map(
    scrapedClasses.map((entry) => [normalizePeriod(entry.period), entry])
  );
  const scrapedByName = new Map(
    scrapedClasses.map((entry) => [normalizeClassName(entry.className), entry])
  );
  return classes.map((classInfo) => ({
    params: { classId: classInfo.class_id || classInfo.period },
    props: (() => {
      const periodKey = normalizePeriod(classInfo.period);
      const nameKey = normalizeClassName(classInfo.class_name);
      const scrapedMatch =
        scrapedByPeriod.get(periodKey) ?? scrapedByName.get(nameKey);
      return {
        classInfo,
        scrapedAssignments: scrapedMatch?.assignments ?? [],
      };
    })(),
  }));
}

function toAssignment(
  scraped: ScrapedAssignment,
  classInfo: Class
): Assignment {
  const maxPoints = Number.isFinite(scraped.totalPoints) ? scraped.totalPoints : 0;
  const dueDate = scraped.dueDate ?? "N/A";
  const isNotGraded = !scraped.graded && maxPoints > 0;
  const isMissing = !isNotGraded && maxPoints > 0 && isPastDue(dueDate);
  const hasScore = scraped.graded && maxPoints > 0;
  const percentage = hasScore
    ? Math.round((scraped.earnedPoints / maxPoints) * 10000) / 100
    : isMissing
    ? 0
    : null;
  const idParts = [classInfo.class_id || classInfo.period, scraped.name, dueDate];

  return {
    id: idParts.filter(Boolean).join(":"),
    name: scraped.name,
    category: "Scraped",
    dueDate,
    score: hasScore ? scraped.earnedPoints : isMissing ? 0 : isNotGraded ? 0 : null,
    maxPoints,
    percentage,
    status: hasScore
      ? "graded"
      : isMissing
      ? "missing"
      : isNotGraded
      ? "not-graded"
      : "pending",
  };
}

const { classInfo, scrapedAssignments } = Astro.props as {
  classInfo: Class;
  scrapedAssignments: ScrapedAssignment[];
};
const scrapedAssignmentRows = scrapedAssignments.map((assignment) =>
  toAssignment(assignment, classInfo)
);

function getGradeColor(grade: number): string {
  if (grade >= 90) return "grade-a";
  if (grade >= 80) return "grade-b";
  if (grade >= 70) return "grade-c";
  if (grade >= 60) return "grade-d";
  return "grade-f";
}

function parseDueDate(value: string): Date | null {
  const match = value.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (!match) return null;
  const month = Number(match[1]);
  const day = Number(match[2]);
  const year = Number(match[3]);
  if (!month || !day || !year) return null;
  const date = new Date(year, month - 1, day);
  return Number.isNaN(date.getTime()) ? null : date;
}

function isPastDue(value: string): boolean {
  const parsed = parseDueDate(value);
  if (!parsed) return false;
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  return parsed.getTime() <= today.getTime();
}

function normalizeAssignments(items: Assignment[]): Assignment[] {
  return items.map((assignment) => {
    const inferredStatus =
      assignment.status ?? (assignment.score !== null ? "graded" : "pending");
    if (inferredStatus === "not-graded") {
      return { ...assignment, status: "not-graded", score: assignment.score ?? 0 };
    }

    const isMissing =
      (inferredStatus === "missing" ||
        (inferredStatus === "pending" &&
          assignment.maxPoints > 0 &&
          isPastDue(assignment.dueDate))) &&
      assignment.maxPoints > 0;

    if (isMissing) {
      return {
        ...assignment,
        status: "missing",
        score: assignment.score ?? 0,
        percentage: assignment.percentage ?? 0,
      };
    }

    return { ...assignment, status: inferredStatus };
  });
}

function getScoreDisplay(assignment: Assignment): string {
  if (assignment.maxPoints > 0 && (assignment.score === null || assignment.status !== "graded")) {
    return `0/${assignment.maxPoints}`;
  }
  if (assignment.score === null) {
    return "PENDING";
  }
  return `${assignment.score}/${assignment.maxPoints}`;
}

function getPercentageDisplay(assignment: Assignment): string {
  if (assignment.percentage === null) {
    return "0%";
  }
  return `${Math.round(assignment.percentage)}%`;
}

const assignments = normalizeAssignments(
  scrapedAssignmentRows.length > 0
    ? scrapedAssignmentRows
    : classInfo.assignments || []
);
const hasAssignments = assignments.length > 0;
const classInfoWithAssignments = { ...classInfo, assignments };
---

<BaseLayout>
  <div class="max-w-[1400px] mx-auto">
    <!-- Back Navigation -->
    <div class="mb-6">
      <a
        href="/"
        class="inline-flex items-center gap-2 text-[#00ff00] hover:text-[#00cc00] transition-colors text-[0.6em] uppercase border-2 border-[#00ff00] hover:border-[#00cc00] px-4 py-2 bg-[#000]"
      >
        <span>‚Üê BACK TO GRADES</span>
      </a>
    </div>

    <!-- Class Header Card -->
    <div
      class="shadow-[0_0_0_4px_#000,0_0_0_8px_#fff,8px_8px_0_8px_rgba(255,255,255,0.3)] relative p-5 border-4 border-solid border-white card mb-8"
      >
        <div
          class="flex items-center gap-[15px] mb-5 pb-[15px] border-b-[3px] border-b-[#555] border-dashed"
        >
        <div
          class="w-12 h-12 flex items-center justify-center text-[1.2em] border-[3px] border-solid border-[#00ff00] bg-[#000]"
        >
          üìä
        </div>
        <div class="flex-1">
          <h1 class="text-[0.8em] text-[#00ff00] uppercase mb-2">
            CLASS.DETAILS - PERIOD {classInfo.period}
          </h1>
          <h2 class="text-[1em] text-white">
            {classInfo.class_name}
          </h2>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-[#000] p-4 border-[3px] border-solid border-[#555]">
          <div class="text-[0.5em] text-[#aaa] uppercase mb-2">Teacher</div>
          <div class="text-[0.7em] text-white">{classInfo.teacher}</div>
        </div>

        <div class="bg-[#000] p-4 border-[3px] border-solid border-[#555]">
          <div class="text-[0.5em] text-[#aaa] uppercase mb-2">
            Current Grade
          </div>
          <div class="flex gap-2 items-center">
            <span
              class={`grade-badge ${getGradeColor(classInfo.current_grade)}`}
            >
              {classInfo.letter_grade}
            </span>
            <span
              class={`grade-badge ${getGradeColor(classInfo.current_grade)}`}
            >
              {classInfo.current_grade}%
            </span>
          </div>
        </div>

        {
          classInfo.q1_grade !== null && (
            <div class="bg-[#000] p-4 border-[3px] border-solid border-[#555]">
              <div class="text-[0.5em] text-[#aaa] uppercase mb-2">
                Q1 Grade
              </div>
              <div class="flex gap-2 items-center">
                <span
                  class={`grade-badge ${getGradeColor(classInfo.q1_grade)}`}
                >
                  {classInfo.q1_letter_grade}
                </span>
                <span
                  class={`grade-badge ${getGradeColor(classInfo.q1_grade)}`}
                >
                  {classInfo.q1_grade}%
                </span>
              </div>
            </div>
          )
        }

        {
          classInfo.q2_grade !== null && (
            <div class="bg-[#000] p-4 border-[3px] border-solid border-[#555]">
              <div class="text-[0.5em] text-[#aaa] uppercase mb-2">
                Q2 Grade
              </div>
              <div class="flex gap-2 items-center">
                <span
                  class={`grade-badge ${getGradeColor(classInfo.q2_grade)}`}
                >
                  {classInfo.q2_letter_grade}
                </span>
                <span
                  class={`grade-badge ${getGradeColor(classInfo.q2_grade)}`}
                >
                  {classInfo.q2_grade}%
                </span>
              </div>
            </div>
          )
        }
      </div>
    </div>

    <!-- Grade Calculator -->
    <GradeCalculator classInfo={classInfoWithAssignments} />

    <!-- Assignments Section -->
    <div
      class="shadow-[0_0_0_4px_#000,0_0_0_8px_#fff,8px_8px_0_8px_rgba(255,255,255,0.3)] relative p-5 border-4 border-solid border-white card"
    >
      <div
        class="flex items-center gap-[15px] mb-5 pb-[15px] border-b-[3px] border-b-[#555] border-dashed"
      >
        <div
          class="w-12 h-12 flex items-center justify-center text-[1.2em] border-[3px] border-solid border-[#00ff00] bg-[#000]"
        >
          üìù
        </div>
        <div class="text-[0.7em] text-[#00ff00]">ASSIGNMENTS.LOG</div>
      </div>
      <div class="text-[0.5em] text-[#aaa] mb-4">
        Click an assignment to see how it could change the class grade.
      </div>

      {
        !hasAssignments ? (
          <div class="text-center py-8">
            <div class="text-[0.6em] text-[#aaa] uppercase">
              No assignment data available for this class yet.
            </div>
            <div class="text-[0.5em] text-[#666] mt-2">
              Run the scraper to collect assignment details.
            </div>
          </div>
        ) : (
          <div class="overflow-x-auto">
            <table class="assignments-table w-full border-collapse">
              <thead>
                <tr class="border-b-[3px] border-b-[#555]">
                  <th class="text-left p-3 text-[0.5em] text-[#00ff00] uppercase">
                    Assignment
                  </th>
                  <th class="text-left p-3 text-[0.5em] text-[#00ff00] uppercase">
                    Due Date
                  </th>
                  <th class="text-right p-3 text-[0.5em] text-[#00ff00] uppercase">
                    Score
                  </th>
                  <th class="text-right p-3 text-[0.5em] text-[#00ff00] uppercase">
                    Percentage
                  </th>
                  <th class="text-center p-3 text-[0.5em] text-[#00ff00] uppercase">
                    Status
                  </th>
                </tr>
              </thead>
              <tbody>
                {assignments.map((assignment) => {
                  return (
                  <tr class="assignments-row border-b border-b-[#333] hover:bg-[#1a1a1a] transition-colors" data-assignment-id={assignment.id}>
                    <td class="assignments-cell p-3 text-[0.5em] text-white" data-label="Assignment">
                      <button
                        type="button"
                        class="assignment-impact-button text-left text-[#00ffff] hover:text-[#00ff00] transition-colors underline decoration-[#00ffff] hover:decoration-[#00ff00]"
                        data-assignment-id={assignment.id}
                        aria-label={`View grade impact for ${assignment.name}`}
                      >
                        {assignment.name}
                      </button>
                    </td>
                    <td class="assignments-cell p-3 text-[0.5em] text-[#aaa]" data-label="Due Date">
                      {assignment.dueDate}
                    </td>
                    <td
                      class={`assignments-cell p-3 text-right text-[0.5em] ${assignment.status === "missing" ? "text-[#E60A18]" : "text-white"}`} data-label="Score"
                    >
                      {getScoreDisplay(assignment)}
                    </td>
                    <td class="assignments-cell p-3 text-right" data-label="Percentage">
                      {assignment.percentage !== null ? (
                        <span
                          class={`grade-badge ${getGradeColor(Math.round(assignment.percentage))}`}
                        >
                          {getPercentageDisplay(assignment)}
                        </span>
                      ) : (
                        <span class="text-[0.5em] text-[#E60A18]">
                          {getPercentageDisplay(assignment)}
                        </span>
                      )}
                    </td>
                    <td class="assignments-cell p-3 text-center" data-label="Status">
                      {assignment.status === "missing" ? (
                        <span class="text-[0.5em] px-3 py-1 bg-[#E60A18] text-white border-2 border-white uppercase">
                          ‚ùå Missing
                        </span>
                      ) : assignment.status === "not-graded" ? (
                        <span class="text-[0.5em] px-3 py-1 bg-[#E6C618] text-black border-2 border-white uppercase">
                          ‚è≥ Not Graded
                        </span>
                      ) : assignment.status === "pending" ? (
                        <span class="text-[0.5em] px-3 py-1 bg-[#E69E18] text-black border-2 border-white uppercase">
                          ‚è≥ Pending
                        </span>
                      ) : (
                        <span class="text-[0.5em] px-3 py-1 bg-[#01BC61] text-black border-2 border-white uppercase">
                          ‚úì Graded
                        </span>
                      )}
                    </td>
                  </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )
      }
    </div>
  </div>

  <div
    id="assignment-impact-modal"
    class="fixed inset-0 bg-black/70 hidden items-center justify-center p-4 z-50"
    role="dialog"
    aria-modal="true"
    aria-hidden="true"
    aria-labelledby="assignment-impact-title"
    aria-describedby="assignment-impact-desc"
  >
    <div class="bg-[#111] border-4 border-white shadow-[0_0_0_4px_#000,0_0_0_8px_#fff,8px_8px_0_8px_rgba(0,255,255,0.3)] max-w-xl w-full p-5">
      <div class="flex items-start justify-between gap-4 mb-4 border-b-2 border-dashed border-[#555] pb-3">
        <div>
          <div id="assignment-impact-title" class="text-[0.7em] text-[#00ff00] uppercase">
            ASSIGNMENT IMPACT
          </div>
          <div id="assignment-impact-name" class="text-[0.65em] text-white mt-1"></div>
        </div>
        <button
          id="assignment-impact-close"
          type="button"
          class="border-2 border-white px-3 py-2 text-[0.55em] uppercase text-white hover:border-[#00ff00] hover:text-[#00ff00] transition-colors"
        >
          Close
        </button>
      </div>
      <div id="assignment-impact-desc" class="space-y-4 text-[0.55em] text-white">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="bg-black p-3 border-2 border-[#555]">
            <div class="text-[#aaa] uppercase mb-1">Due Date</div>
            <div id="assignment-impact-due"></div>
          </div>
          <div class="bg-black p-3 border-2 border-[#555]">
            <div class="text-[#aaa] uppercase mb-1">Current Score</div>
            <div id="assignment-impact-score"></div>
          </div>
          <div class="bg-black p-3 border-2 border-[#555]">
            <div class="text-[#aaa] uppercase mb-1">Worth</div>
            <div id="assignment-impact-worth"></div>
          </div>
          <div class="bg-black p-3 border-2 border-[#555]">
            <div class="text-[#aaa] uppercase mb-1">Status</div>
            <div id="assignment-impact-status"></div>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="bg-black p-3 border-2 border-[#555]">
            <div class="text-[#aaa] uppercase mb-1">Current Grade</div>
            <div id="assignment-impact-current"></div>
          </div>
          <div class="bg-black p-3 border-2 border-[#00ff00]">
            <div class="text-[#aaa] uppercase mb-1">If 100%</div>
            <div id="assignment-impact-projected"></div>
          </div>
          <div class="bg-black p-3 border-2 border-[#555]">
            <div class="text-[#aaa] uppercase mb-1">Change</div>
            <div id="assignment-impact-delta"></div>
          </div>
        </div>
        <div class="text-[0.45em] text-[#aaa] uppercase">
          Projection assumes full points on this assignment.
        </div>
      </div>
    </div>
  </div>

  <script define:vars={{ assignmentsData: JSON.stringify(assignments) }} data-astro-rerun>
    function initAssignmentImpact() {
      const assignments = JSON.parse(assignmentsData);
      const modal = document.getElementById('assignment-impact-modal');
      const closeButton = document.getElementById('assignment-impact-close');
      const nameEl = document.getElementById('assignment-impact-name');
      const dueEl = document.getElementById('assignment-impact-due');
      const scoreEl = document.getElementById('assignment-impact-score');
      const worthEl = document.getElementById('assignment-impact-worth');
      const statusEl = document.getElementById('assignment-impact-status');
      const currentEl = document.getElementById('assignment-impact-current');
      const projectedEl = document.getElementById('assignment-impact-projected');
      const deltaEl = document.getElementById('assignment-impact-delta');
      const buttons = document.querySelectorAll('.assignment-impact-button');

      if (!modal || !closeButton) {
        return;
      }

      let lastFocused = null;

      function computeTotals(list) {
        return list.reduce(
          (totals, assignment) => {
            if (assignment.maxPoints <= 0) {
              return totals;
            }
            const earned = assignment.score === null ? 0 : assignment.score;
            totals.earned += earned;
            totals.possible += assignment.maxPoints;
            return totals;
          },
          { earned: 0, possible: 0 }
        );
      }

      function formatGrade(value) {
        if (value === null || Number.isNaN(value)) {
          return 'N/A';
        }
        return `${value.toFixed(1)}%`;
      }

      function calculateGrade(earned, possible) {
        if (!possible) {
          return null;
        }
        return Math.round((earned / possible) * 1000) / 10;
      }

      function openModal(assignment) {
        const totals = computeTotals(assignments);
        const currentGrade = calculateGrade(totals.earned, totals.possible);
        const currentScore = assignment.score === null ? 0 : assignment.score;
        const projectedEarned = totals.earned - currentScore + assignment.maxPoints;
        const projectedGrade =
          assignment.maxPoints > 0 ? calculateGrade(projectedEarned, totals.possible) : null;
        const delta = projectedGrade === null || currentGrade === null ? null : projectedGrade - currentGrade;

        nameEl.textContent = assignment.name;
        dueEl.textContent = assignment.dueDate;
        scoreEl.textContent =
          assignment.score === null ? 'PENDING' : `${assignment.score}/${assignment.maxPoints}`;
        worthEl.textContent = `${assignment.maxPoints} pts`;
        statusEl.textContent = assignment.status.toUpperCase();
        currentEl.textContent = formatGrade(currentGrade);
        projectedEl.textContent = formatGrade(projectedGrade);
        deltaEl.textContent = delta === null ? 'N/A' : `${delta >= 0 ? '+' : ''}${delta.toFixed(1)}%`;
        deltaEl.style.color =
          delta === null ? '#aaa' : delta > 0.5 ? '#01BC61' : delta < -0.5 ? '#E60A18' : '#aaa';

        modal.classList.remove('hidden');
        modal.classList.add('flex');
        modal.setAttribute('aria-hidden', 'false');
        lastFocused = document.activeElement;
        closeButton.focus();
      }

      function closeModal() {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        modal.setAttribute('aria-hidden', 'true');
        if (lastFocused instanceof HTMLElement) {
          lastFocused.focus();
        }
      }

      closeButton.addEventListener('click', closeModal);
      modal.addEventListener('click', (event) => {
        if (event.target === modal) {
          closeModal();
        }
      });
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && !modal.classList.contains('hidden')) {
          closeModal();
        }
      });

      buttons.forEach((button) => {
        if (button.dataset.listenerAttached === 'true') {
          return;
        }
        button.dataset.listenerAttached = 'true';
        button.addEventListener('click', () => {
          const assignmentId = button.dataset.assignmentId;
          const assignment = assignments.find((item) => item.id === assignmentId);
          if (!assignment) {
            return;
          }
          openModal(assignment);
        });
      });
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initAssignmentImpact);
    } else {
      setTimeout(initAssignmentImpact, 50);
    }
  </script>

  <style>
    @media (max-width: 640px) {
      .assignments-table thead {
        display: none;
      }

      .assignments-table,
      .assignments-table tbody,
      .assignments-table tr,
      .assignments-table td {
        display: block;
        width: 100%;
      }

      .assignments-row {
        border: 2px solid #333;
        padding: 10px;
        margin-bottom: 12px;
        background: #000;
      }

      .assignments-cell {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 10px;
        padding: 6px 0;
        text-align: left;
      }

      .assignments-cell::before {
        content: attr(data-label);
        flex: 0 0 auto;
        color: #00ff00;
        text-transform: uppercase;
        font-size: 0.45em;
        letter-spacing: 0.08em;
      }

      .assignments-cell .grade-badge {
        font-size: 0.5em;
      }
      .assignment-impact-button {
        font-size: 1em;
      }
    }
  </style>
</BaseLayout>

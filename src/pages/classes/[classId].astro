---
import BaseLayout from "../../layouts/BaseLayout.astro";
import GradeCalculator from "../../components/GradeCalculator.astro";
import gradesData from "../../data/grades.json";
import type { Class, Assignment } from "../../types/grades";
import fs from "node:fs/promises";
import path from "node:path";

type ScrapedAssignment = {
  name: string;
  dueDate: string | null;
  earnedPoints: number;
  totalPoints: number;
  graded: boolean;
};

type ScrapedClass = {
  className: string;
  period: string;
  assignments: ScrapedAssignment[];
};

type ScrapedGrades = {
  classes?: ScrapedClass[];
};

export async function getStaticPaths() {
  const normalizeClassName = (value: string): string =>
    value.trim().toLowerCase().replace(/[^a-z0-9]+/g, " ");
  const normalizePeriod = (value: string): string => value.trim();

  const classes = gradesData.classes as Class[];
  let scrapedClasses: ScrapedClass[] = [];
  try {
    const scrapedPath = path.resolve("scraper", "detailed-grades.json");
    const raw = await fs.readFile(scrapedPath, "utf8");
    const parsed = JSON.parse(raw) as ScrapedGrades;
    scrapedClasses = parsed?.classes ?? [];
  } catch (error) {
    scrapedClasses = [];
  }
  const scrapedByPeriod = new Map(
    scrapedClasses.map((entry) => [normalizePeriod(entry.period), entry])
  );
  const scrapedByName = new Map(
    scrapedClasses.map((entry) => [normalizeClassName(entry.className), entry])
  );
  return classes.map((classInfo) => ({
    params: { classId: classInfo.class_id || classInfo.period },
    props: (() => {
      const periodKey = normalizePeriod(classInfo.period);
      const nameKey = normalizeClassName(classInfo.class_name);
      const scrapedMatch =
        scrapedByPeriod.get(periodKey) ?? scrapedByName.get(nameKey);
      return {
        classInfo,
        scrapedAssignments: scrapedMatch?.assignments ?? [],
      };
    })(),
  }));
}

function toAssignment(
  scraped: ScrapedAssignment,
  classInfo: Class
): Assignment {
  const maxPoints = Number.isFinite(scraped.totalPoints) ? scraped.totalPoints : 0;
  const dueDate = scraped.dueDate ?? "N/A";
  const isMissing = !scraped.graded && maxPoints > 0 && isPastDue(dueDate);
  const hasScore = scraped.graded && maxPoints > 0;
  const percentage = hasScore
    ? Math.round((scraped.earnedPoints / maxPoints) * 10000) / 100
    : isMissing
    ? 0
    : null;
  const idParts = [classInfo.class_id || classInfo.period, scraped.name, dueDate];

  return {
    id: idParts.filter(Boolean).join(":"),
    name: scraped.name,
    category: "Scraped",
    dueDate,
    score: hasScore ? scraped.earnedPoints : isMissing ? 0 : null,
    maxPoints,
    percentage,
    status: hasScore ? "graded" : isMissing ? "missing" : "pending",
  };
}

const { classInfo, scrapedAssignments } = Astro.props as {
  classInfo: Class;
  scrapedAssignments: ScrapedAssignment[];
};
const scrapedAssignmentRows = scrapedAssignments.map((assignment) =>
  toAssignment(assignment, classInfo)
);

function getGradeColor(grade: number): string {
  if (grade >= 90) return "grade-a";
  if (grade >= 80) return "grade-b";
  if (grade >= 70) return "grade-c";
  if (grade >= 60) return "grade-d";
  return "grade-f";
}

function parseDueDate(value: string): Date | null {
  const match = value.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
  if (!match) return null;
  const month = Number(match[1]);
  const day = Number(match[2]);
  const year = Number(match[3]);
  if (!month || !day || !year) return null;
  const date = new Date(year, month - 1, day);
  return Number.isNaN(date.getTime()) ? null : date;
}

function isPastDue(value: string): boolean {
  const parsed = parseDueDate(value);
  if (!parsed) return false;
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  return parsed.getTime() <= today.getTime();
}

function normalizeAssignments(items: Assignment[]): Assignment[] {
  return items.map((assignment) => {
    const inferredStatus =
      assignment.status ?? (assignment.score !== null ? "graded" : "pending");
    const isMissing =
      (inferredStatus === "missing" ||
        (inferredStatus === "pending" &&
          assignment.maxPoints > 0 &&
          isPastDue(assignment.dueDate))) &&
      assignment.maxPoints > 0;

    if (!isMissing) {
      return { ...assignment, status: inferredStatus };
    }

    return {
      ...assignment,
      status: "missing",
      score: assignment.score ?? 0,
      percentage: assignment.percentage ?? 0,
    };
  });
}

function getScoreDisplay(assignment: Assignment): string {
  if (assignment.status === "missing" && assignment.maxPoints > 0) {
    return `0/${assignment.maxPoints}`;
  }
  if (assignment.score === null) {
    return "PENDING";
  }
  return `${assignment.score}/${assignment.maxPoints}`;
}

function getPercentageDisplay(assignment: Assignment): string {
  if (assignment.percentage === null) {
    return "0%";
  }
  return `${Math.round(assignment.percentage)}%`;
}

const assignments = normalizeAssignments(
  scrapedAssignmentRows.length > 0
    ? scrapedAssignmentRows
    : classInfo.assignments || []
);
const hasAssignments = assignments.length > 0;
const classInfoWithAssignments = { ...classInfo, assignments };
---

<BaseLayout>
  <div class="max-w-[1400px] mx-auto">
    <!-- Back Navigation -->
    <div class="mb-6">
      <a
        href="/"
        class="inline-flex items-center gap-2 text-[#00ff00] hover:text-[#00cc00] transition-colors text-[0.6em] uppercase border-2 border-[#00ff00] hover:border-[#00cc00] px-4 py-2 bg-[#000]"
      >
        <span>‚Üê BACK TO GRADES</span>
      </a>
    </div>

    <!-- Class Header Card -->
    <div
      class="shadow-[0_0_0_4px_#000,0_0_0_8px_#fff,8px_8px_0_8px_rgba(255,255,255,0.3)] relative p-5 border-4 border-solid border-white card mb-8"
    >
      <div
        class="flex items-center gap-[15px] mb-5 pb-[15px] border-b-[3px] border-b-[#555] border-dashed"
      >
        <div
          class="w-12 h-12 flex items-center justify-center text-[1.2em] border-[3px] border-solid border-[#00ff00] bg-[#000]"
        >
          üìä
        </div>
        <div class="flex-1">
          <h1 class="text-[0.8em] text-[#00ff00] uppercase mb-2">
            CLASS.DETAILS - PERIOD {classInfo.period}
          </h1>
          <h2 class="text-[1em] text-white">
            {classInfo.class_name}
          </h2>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-[#000] p-4 border-[3px] border-solid border-[#555]">
          <div class="text-[0.5em] text-[#aaa] uppercase mb-2">Teacher</div>
          <div class="text-[0.7em] text-white">{classInfo.teacher}</div>
        </div>

        <div class="bg-[#000] p-4 border-[3px] border-solid border-[#555]">
          <div class="text-[0.5em] text-[#aaa] uppercase mb-2">
            Current Grade
          </div>
          <div class="flex gap-2 items-center">
            <span
              class={`grade-badge ${getGradeColor(classInfo.current_grade)}`}
            >
              {classInfo.letter_grade}
            </span>
            <span
              class={`grade-badge ${getGradeColor(classInfo.current_grade)}`}
            >
              {classInfo.current_grade}%
            </span>
          </div>
        </div>

        {
          classInfo.q1_grade !== null && (
            <div class="bg-[#000] p-4 border-[3px] border-solid border-[#555]">
              <div class="text-[0.5em] text-[#aaa] uppercase mb-2">
                Q1 Grade
              </div>
              <div class="flex gap-2 items-center">
                <span
                  class={`grade-badge ${getGradeColor(classInfo.q1_grade)}`}
                >
                  {classInfo.q1_letter_grade}
                </span>
                <span
                  class={`grade-badge ${getGradeColor(classInfo.q1_grade)}`}
                >
                  {classInfo.q1_grade}%
                </span>
              </div>
            </div>
          )
        }

        {
          classInfo.q2_grade !== null && (
            <div class="bg-[#000] p-4 border-[3px] border-solid border-[#555]">
              <div class="text-[0.5em] text-[#aaa] uppercase mb-2">
                Q2 Grade
              </div>
              <div class="flex gap-2 items-center">
                <span
                  class={`grade-badge ${getGradeColor(classInfo.q2_grade)}`}
                >
                  {classInfo.q2_letter_grade}
                </span>
                <span
                  class={`grade-badge ${getGradeColor(classInfo.q2_grade)}`}
                >
                  {classInfo.q2_grade}%
                </span>
              </div>
            </div>
          )
        }
      </div>
    </div>

    <!-- Grade Calculator -->
    <GradeCalculator classInfo={classInfoWithAssignments} />

    <!-- Assignments Section -->
    <div
      class="shadow-[0_0_0_4px_#000,0_0_0_8px_#fff,8px_8px_0_8px_rgba(255,255,255,0.3)] relative p-5 border-4 border-solid border-white card"
    >
      <div
        class="flex items-center gap-[15px] mb-5 pb-[15px] border-b-[3px] border-b-[#555] border-dashed"
      >
        <div
          class="w-12 h-12 flex items-center justify-center text-[1.2em] border-[3px] border-solid border-[#00ff00] bg-[#000]"
        >
          üìù
        </div>
        <div class="text-[0.7em] text-[#00ff00]">ASSIGNMENTS.LOG</div>
      </div>

      {
        !hasAssignments ? (
          <div class="text-center py-8">
            <div class="text-[0.6em] text-[#aaa] uppercase">
              No assignment data available for this class yet.
            </div>
            <div class="text-[0.5em] text-[#666] mt-2">
              Run the scraper to collect assignment details.
            </div>
          </div>
        ) : (
          <div class="overflow-x-auto">
            <table class="assignments-table w-full border-collapse">
              <thead>
                <tr class="border-b-[3px] border-b-[#555]">
                  <th class="text-center p-3 text-[0.5em] text-[#00ff00] uppercase w-12">
                    Simulate
                  </th>
                  <th class="text-left p-3 text-[0.5em] text-[#00ff00] uppercase">
                    Assignment
                  </th>
                  <th class="text-left p-3 text-[0.5em] text-[#00ff00] uppercase">
                    Due Date
                  </th>
                  <th class="text-right p-3 text-[0.5em] text-[#00ff00] uppercase">
                    Score
                  </th>
                  <th class="text-right p-3 text-[0.5em] text-[#00ff00] uppercase">
                    Percentage
                  </th>
                  <th class="text-center p-3 text-[0.5em] text-[#00ff00] uppercase">
                    Status
                  </th>
                </tr>
              </thead>
              <tbody>
                {assignments.map((assignment) => {
                  const isMissingOrPending = assignment.status === "missing" || assignment.status === "pending";
                  const canSimulate = isMissingOrPending && assignment.maxPoints > 0;
                  return (
                  <tr class="assignments-row border-b border-b-[#333] hover:bg-[#1a1a1a] transition-colors" data-assignment-id={assignment.id}>
                    <td class="assignments-cell p-3 text-center" data-label="Simulate">
                      {canSimulate ? (
                        <input
                          type="checkbox"
                          class="assignment-simulate-checkbox w-4 h-4 border-2 border-[#00ff00] bg-[#000] text-[#00ff00] focus:ring-2 focus:ring-[#00ff00] cursor-pointer"
                          data-assignment-id={assignment.id}
                          aria-label={`Simulate ${assignment.name} at 100%`}
                        />
                      ) : (
                        <span class="text-[0.4em] text-[#555]">-</span>
                      )}
                    </td>
                    <td class="assignments-cell p-3 text-[0.5em] text-white" data-label="Assignment">
                      {assignment.name}
                    </td>
                    <td class="assignments-cell p-3 text-[0.5em] text-[#aaa]" data-label="Due Date">
                      {assignment.dueDate}
                    </td>
                    <td
                      class={`assignments-cell p-3 text-right text-[0.5em] ${assignment.status === "missing" ? "text-[#E60A18]" : "text-white"}`} data-label="Score"
                    >
                      {getScoreDisplay(assignment)}
                    </td>
                    <td class="assignments-cell p-3 text-right" data-label="Percentage">
                      {assignment.percentage !== null ? (
                        <span
                          class={`grade-badge ${getGradeColor(Math.round(assignment.percentage))}`}
                        >
                          {getPercentageDisplay(assignment)}
                        </span>
                      ) : (
                        <span class="text-[0.5em] text-[#E60A18]">
                          {getPercentageDisplay(assignment)}
                        </span>
                      )}
                    </td>
                    <td class="assignments-cell p-3 text-center" data-label="Status">
                      {assignment.status === "missing" ? (
                        <span class="text-[0.5em] px-3 py-1 bg-[#E60A18] text-white border-2 border-white uppercase">
                          ‚ùå Missing
                        </span>
                      ) : assignment.status === "pending" ? (
                        <span class="text-[0.5em] px-3 py-1 bg-[#E69E18] text-black border-2 border-white uppercase">
                          ‚è≥ Pending
                        </span>
                      ) : (
                        <span class="text-[0.5em] px-3 py-1 bg-[#01BC61] text-black border-2 border-white uppercase">
                          ‚úì Graded
                        </span>
                      )}
                    </td>
                  </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )
      }
    </div>
  </div>

  <script define:vars={{ assignmentsData: JSON.stringify(assignments) }}>
    import type { Assignment } from "../../types/grades";

    // Wait for DOM to be fully ready
    function initCheckboxSimulation() {
      // Get assignments data from Astro
      const assignments: Assignment[] = JSON.parse(assignmentsData);
      const calculatorElement = document.getElementById('grade-calculator');
      
      if (!calculatorElement) {
        console.error('Calculator element not found');
        return;
      }

    // Track checked assignment IDs
    const checkedAssignmentIds = new Set<string>();

      // Helper function to simulate checked assignments at 100%
      function simulateAssignments(originalAssignments: Assignment[], checkedIds: Set<string>): Assignment[] {
      return originalAssignments.map((assignment) => {
        // If this assignment is checked and is missing/pending, simulate it at 100%
        if (checkedIds.has(assignment.id) && (assignment.status === 'missing' || assignment.status === 'pending') && assignment.maxPoints > 0) {
          return {
            ...assignment,
            score: assignment.maxPoints,
            percentage: 100,
            status: 'graded' as const,
          };
        }
        return assignment;
      });
    }

      // Calculate grade with simulated assignments (no hypothetical assignment)
      function calculateGradeWithSimulatedAssignments() {
      const simulatedAssignments = simulateAssignments(assignments, checkedAssignmentIds);
      
      // Filter to graded assignments (including simulated ones)
      const gradedAssignments = simulatedAssignments.filter(
        (a) => a.score !== null && a.percentage !== null && a.maxPoints > 0
      );

      if (gradedAssignments.length === 0) {
        return null;
      }

      // Calculate totals
      const totalEarned = gradedAssignments.reduce((sum, a) => sum + (a.score ?? 0), 0);
      const totalPossible = gradedAssignments.reduce((sum, a) => sum + a.maxPoints, 0);

      if (totalPossible === 0) {
        return null;
      }

      const calculatedGrade = Math.min(100, (totalEarned / totalPossible) * 100);
      return Math.round(calculatedGrade * 100) / 100;
    }

      // Update calculator with simulated assignments
      function updateCalculatorAssignments() {
      const simulatedAssignments = simulateAssignments(assignments, checkedAssignmentIds);
      if (calculatorElement) {
        calculatorElement.setAttribute('data-assignments', JSON.stringify(simulatedAssignments));
        calculatorElement.setAttribute('data-has-assignments', simulatedAssignments.length > 0 ? 'true' : 'false');
      }
    }

      // Update displayed grade when checkboxes change
      function updateGradeDisplay() {
      const simulatedGrade = calculateGradeWithSimulatedAssignments();
      const originalGrade = parseFloat(calculatorElement?.dataset.currentGrade || '0');
      
      // Always try to update calculator results if they exist
      const resultsContainer = document.getElementById('results-container');
      const calculateBtn = document.getElementById('calculate-btn') as HTMLButtonElement;
      
      if (resultsContainer && !resultsContainer.classList.contains('hidden') && calculateBtn && !calculateBtn.disabled) {
        // If calculator has results, trigger recalculation to update them
        calculateBtn.click();
      } else if (simulatedGrade !== null && checkedAssignmentIds.size > 0) {
        // Show a preview card above the calculator
        const delta = simulatedGrade - originalGrade;
        const deltaSign = delta >= 0 ? '+' : '';
        const deltaColor = delta > 0.5 ? '#01BC61' : delta < -0.5 ? '#E60A18' : '#aaa';
        const deltaIcon = delta > 0.5 ? '‚ñ≤' : delta < -0.5 ? '‚ñº' : '‚óè';
        
        // Get letter grade
        function getLetterGrade(grade: number): string {
          if (grade >= 90) return 'A';
          if (grade >= 80) return 'B';
          if (grade >= 70) return 'C';
          if (grade >= 60) return 'D';
          return 'F';
        }
        
        // Create or update a preview element
        let previewElement = document.getElementById('simulated-grade-preview');
        if (!previewElement) {
          previewElement = document.createElement('div');
          previewElement.id = 'simulated-grade-preview';
          previewElement.className = 'shadow-[0_0_0_4px_#000,0_0_0_8px_#fff,8px_8px_0_8px_rgba(255,255,255,0.3)] relative p-5 border-4 border-solid border-white card mb-4';
        }
        
        previewElement.innerHTML = `
          <div class="flex items-center gap-[15px] mb-4 pb-[15px] border-b-[3px] border-b-[#555] border-dashed">
            <div class="w-10 h-10 flex items-center justify-center text-[1em] border-[3px] border-solid border-[#00ff00] bg-[#000]">
              üìä
            </div>
            <div class="text-[0.6em] text-[#00ff00] uppercase font-bold">SIMULATED GRADE PREVIEW</div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-[#000] p-3 border-[2px] border-[#555]">
              <div class="text-[0.4em] text-[#aaa] uppercase mb-2">Current Grade</div>
              <div class="text-[0.7em] text-white font-bold">${originalGrade.toFixed(1)}%</div>
            </div>
            <div class="bg-[#000] p-3 border-[2px] border-[#00ff00]">
              <div class="text-[0.4em] text-[#aaa] uppercase mb-2">With Checked Assignments</div>
              <div class="flex items-center gap-2">
                <span class="text-[0.6em] text-white font-bold">${getLetterGrade(simulatedGrade)}</span>
                <span class="text-[0.7em] text-white font-bold">${simulatedGrade.toFixed(1)}%</span>
              </div>
            </div>
            <div class="bg-[#000] p-3 border-[2px] border-[#555]">
              <div class="text-[0.4em] text-[#aaa] uppercase mb-2">Change</div>
              <div class="text-[0.7em] font-bold" style="color: ${deltaColor}">
                ${deltaIcon} ${deltaSign}${delta.toFixed(1)}%
              </div>
            </div>
          </div>
        `;
        
        // Insert before calculator if not already there
        if (!previewElement.parentNode) {
          calculatorElement?.parentNode?.insertBefore(previewElement, calculatorElement);
        }
      } else {
        // Remove preview if no assignments are checked
        const previewElement = document.getElementById('simulated-grade-preview');
        if (previewElement) {
          previewElement.remove();
        }
      }
    }

      // Handle checkbox changes
      function setupCheckboxes() {
        const checkboxes = document.querySelectorAll('.assignment-simulate-checkbox');
        console.log(`Found ${checkboxes.length} checkboxes to setup`);
        
        checkboxes.forEach((checkbox) => {
          const checkboxElement = checkbox as HTMLInputElement;
          const assignmentId = checkboxElement.dataset.assignmentId;
          
          if (!assignmentId) {
            console.error('No assignment ID found on checkbox');
            return;
          }
          
          // Add event listener
          checkboxElement.addEventListener('change', (event) => {
            const target = event.target as HTMLInputElement;
            const id = target.dataset.assignmentId;
            
            console.log('Checkbox changed:', id, target.checked);
            
            if (!id) {
              console.error('No assignment ID found on checkbox');
              return;
            }

            if (target.checked) {
              checkedAssignmentIds.add(id);
            } else {
              checkedAssignmentIds.delete(id);
            }

            console.log('Checked IDs:', Array.from(checkedAssignmentIds));

            // Update calculator with new simulated assignments
            updateCalculatorAssignments();

            // Update grade display
            updateGradeDisplay();
          });
        });
      }

      // Wait for DOM to be ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
          setupCheckboxes();
          updateCalculatorAssignments();
          updateGradeDisplay();
        });
      } else {
        // Use setTimeout to ensure all elements are rendered
        setTimeout(() => {
          setupCheckboxes();
          updateCalculatorAssignments();
          updateGradeDisplay();
        }, 100);
      }
    }

    // Initialize when script loads
    initCheckboxSimulation();
  </script>

  <style>
    @media (max-width: 640px) {
      .assignments-table thead {
        display: none;
      }

      .assignments-table,
      .assignments-table tbody,
      .assignments-table tr,
      .assignments-table td {
        display: block;
        width: 100%;
      }

      .assignments-row {
        border: 2px solid #333;
        padding: 10px;
        margin-bottom: 12px;
        background: #000;
      }

      .assignments-cell {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 10px;
        padding: 6px 0;
        text-align: left;
      }

      .assignments-cell::before {
        content: attr(data-label);
        flex: 0 0 auto;
        color: #00ff00;
        text-transform: uppercase;
        font-size: 0.45em;
        letter-spacing: 0.08em;
      }

      .assignments-cell .grade-badge {
        font-size: 0.5em;
      }

      /* Hide simulate column label on mobile for cleaner display */
      .assignments-cell[data-label="Simulate"]::before {
        display: none;
      }
    }
  </style>
</BaseLayout>

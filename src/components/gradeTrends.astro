---
import gradesData from '../data/grades.json';

// Extract grade history data
const gradeHistory = gradesData.grade_history;
const classes = Object.keys(gradeHistory);

// Get all dates (from the first class)
const dates = Object.keys(gradeHistory[classes[0]]).sort((a, b) =>
    new Date(a).getTime() - new Date(b).getTime()
);

// Generate colors for each class
const colors = [
    '#ef4444', // red
    '#3b82f6', // blue
    '#10b981', // green
    '#f59e0b', // amber
    '#8b5cf6', // purple
    '#ec4899', // pink
    '#14b8a6', // teal
    '#f97316', // orange
    '#6366f1', // indigo
];

// Prepare datasets for Chart.js
const datasets = classes.map((className, index) => ({
    label: className,
    data: dates.map(date => gradeHistory[className][date]),
    borderColor: colors[index % colors.length],
    backgroundColor: colors[index % colors.length] + '20',
    tension: 0.4,
}));
---

<section class="mb-16" aria-labelledby="grade-trends-heading">
    <h1 id="grade-trends-heading" class="capitalize font-bold mb-6 text-xl md:text-3xl text-center text-blue-400 font-player px-2">
        Grade Trends
    </h1>
    <div class="container mx-auto px-2 md:px-4">
        <div class="bg-gray-800 p-2 md:p-6 rounded-lg">
            <canvas
                id="gradeChart"
                role="img"
                aria-label="Line chart showing grade trends over time for all classes"
                data-dates={JSON.stringify(dates)}
                data-datasets={JSON.stringify(datasets)}
            ></canvas>
        </div>
    </div>
</section>

<script>
    import Chart from 'chart.js/auto';

    const dates = JSON.parse(document.getElementById('gradeChart').dataset.dates);
    const datasets = JSON.parse(document.getElementById('gradeChart').dataset.datasets);

    const ctx = document.getElementById('gradeChart');

    const isMobile = window.innerWidth < 768;

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: datasets,
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: isMobile ? 1.2 : 2.5,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: '#e5e7eb',
                        padding: isMobile ? 8 : 15,
                        font: {
                            size: isMobile ? 10 : 12,
                        },
                        boxWidth: isMobile ? 15 : 40,
                        boxHeight: isMobile ? 15 : 12,
                    },
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    titleFont: {
                        size: isMobile ? 11 : 13,
                    },
                    bodyFont: {
                        size: isMobile ? 10 : 12,
                    },
                },
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    title: {
                        display: !isMobile,
                        text: 'Grade (%)',
                        color: '#e5e7eb',
                        font: {
                            size: isMobile ? 10 : 12,
                        },
                    },
                    ticks: {
                        color: '#e5e7eb',
                        font: {
                            size: isMobile ? 9 : 11,
                        },
                    },
                    grid: {
                        color: '#374151',
                    },
                },
                x: {
                    title: {
                        display: !isMobile,
                        text: 'Date',
                        color: '#e5e7eb',
                        font: {
                            size: isMobile ? 10 : 12,
                        },
                    },
                    ticks: {
                        color: '#e5e7eb',
                        maxRotation: isMobile ? 90 : 45,
                        minRotation: isMobile ? 90 : 45,
                        font: {
                            size: isMobile ? 8 : 11,
                        },
                    },
                    grid: {
                        color: '#374151',
                    },
                },
            },
        },
    });
</script>
